---
import AdminLayout from "../../layouts/AdminLayout.astro"
import { createDB, getAdminById, getSetting, setSetting, createLog, deleteOldEmails } from "database"
import { verifyToken } from "../../lib/auth"
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "../../components/ui/card"
import { Button } from "../../components/ui/button"
import { Input } from "../../components/ui/input"
import { Badge } from "../../components/ui/badge"
import { Globe, Trash2, Save, AlertTriangle, Check, Star } from "lucide-react"

const db = createDB(Astro.locals.runtime.env.DB)
const jwtSecret = Astro.locals.runtime.env.JWT_SECRET

// 验证登录
const token = Astro.cookies.get("admin_token")?.value
if (!token) return Astro.redirect("/admin/login")
const payload = await verifyToken(token, jwtSecret)
if (!payload || payload.type !== "admin") return Astro.redirect("/admin/login")
const admin = await getAdminById(db, payload.id)
if (!admin) return Astro.redirect("/admin/login")

let message = ""
let messageType: "success" | "error" = "success"

// 处理表单提交
if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData()
  const action = formData.get("action")?.toString()

  if (action === "add_domain") {
    const newDomain = formData.get("new_domain")?.toString()?.toLowerCase()?.trim()
    if (newDomain) {
      const currentDomains = await getSetting(db, "mail_domains") || ""
      const domainList = currentDomains ? currentDomains.split(",").map(d => d.trim()).filter(Boolean) : []
      if (!domainList.includes(newDomain)) {
        domainList.push(newDomain)
        await setSetting(db, "mail_domains", domainList.join(","))
        await createLog(db, { adminId: admin.id, action: "add_mail_domain", target: newDomain })
        message = `域名 ${newDomain} 添加成功`
      } else {
        message = "该域名已存在"
        messageType = "error"
      }
    }
  } else if (action === "remove_domain") {
    const domain = formData.get("domain")?.toString()
    if (domain) {
      const currentDomains = await getSetting(db, "mail_domains") || ""
      const domainList = currentDomains.split(",").map(d => d.trim()).filter(d => d && d !== domain)
      await setSetting(db, "mail_domains", domainList.join(","))
      await createLog(db, { adminId: admin.id, action: "remove_mail_domain", target: domain })
      message = `域名 ${domain} 已删除`
    }
  } else if (action === "set_default") {
    const domain = formData.get("domain")?.toString()
    if (domain) {
      await setSetting(db, "default_mail_domain", domain)
      await createLog(db, { adminId: admin.id, action: "set_default_domain", target: domain })
      message = `已将 ${domain} 设为默认域名`
    }
  } else if (action === "save_retention") {
    const days = formData.get("retention_days")?.toString()
    if (days) {
      await setSetting(db, "retention_days", days)
      await createLog(db, { adminId: admin.id, action: "set_retention_days", details: { days } })
      message = `邮件保留天数已设置为 ${days} 天`
    }
  } else if (action === "cleanup") {
    const days = parseInt(await getSetting(db, "retention_days") || "30")
    const deleted = await deleteOldEmails(db, days)
    await createLog(db, { adminId: admin.id, action: "cleanup_emails", details: { deleted, days } })
    message = `已清理 ${deleted} 封过期邮件`
  }
}

// 获取当前设置
const mailDomainsStr = await getSetting(db, "mail_domains") || ""
const mailDomains = mailDomainsStr ? mailDomainsStr.split(",").map(d => d.trim()).filter(Boolean) : []
const defaultDomain = await getSetting(db, "default_mail_domain") || mailDomains[0] || ""
const retentionDays = await getSetting(db, "retention_days") || "30"
---

<AdminLayout title="系统设置">
  <div class="space-y-6">
    <h1 class="text-3xl font-bold tracking-tight">系统设置</h1>

    {message && (
      <div class={`p-4 rounded-md border ${messageType === "success" ? "bg-green-50 text-green-900 border-green-200" : "bg-red-50 text-red-900 border-red-200"}`}>
        {message}
      </div>
    )}

    <div class="grid gap-6 md:grid-cols-2">
      <!-- 邮箱域名 -->
      <Card className="md:col-span-2 lg:col-span-1">
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Globe className="h-5 w-5" />
            邮箱域名
          </CardTitle>
          <CardDescription>管理系统支持的邮箱域名</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <form method="POST" class="flex gap-2">
            <input type="hidden" name="action" value="add_domain" />
            <Input type="text" name="new_domain" required placeholder="example.com" />
            <Button type="submit">添加</Button>
          </form>
          
          {mailDomains.length === 0 ? (
            <p class="text-muted-foreground text-sm text-center py-4">暂无域名，请添加</p>
          ) : (
            <div class="space-y-2">
              {mailDomains.map((domain) => (
                <div class="flex items-center justify-between p-3 bg-muted/50 rounded-md border">
                  <div class="flex items-center gap-2">
                    <span class="font-mono text-sm">{domain}</span>
                    {domain === defaultDomain && <Badge variant="default" className="text-[10px] h-5">默认</Badge>}
                  </div>
                  <div class="flex gap-2">
                    {domain !== defaultDomain && (
                      <form method="POST" class="inline">
                        <input type="hidden" name="action" value="set_default" />
                        <input type="hidden" name="domain" value={domain} />
                        <Button type="submit" variant="ghost" size="icon" className="h-8 w-8 text-primary hover:text-primary" title="设为默认">
                          <Star className="h-4 w-4" />
                        </Button>
                      </form>
                    )}
                    <form method="POST" class="inline" onsubmit="return confirm('确定删除？')">
                      <input type="hidden" name="action" value="remove_domain" />
                      <input type="hidden" name="domain" value={domain} />
                      <Button type="submit" variant="ghost" size="icon" className="h-8 w-8 text-destructive hover:text-destructive" title="删除">
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    </form>
                  </div>
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>

      <!-- 邮件保留 -->
      <Card className="md:col-span-2 lg:col-span-1">
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Trash2 className="h-5 w-5" />
            邮件保留策略
          </CardTitle>
          <CardDescription>自动清理过期邮件以节省空间</CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
          <div class="space-y-4">
            <form method="POST" class="flex gap-4 items-end">
              <input type="hidden" name="action" value="save_retention" />
              <div class="space-y-2 flex-1">
                <label class="text-sm font-medium leading-none">保留天数</label>
                <Input type="number" name="retention_days" value={retentionDays} min="1" max="365" />
              </div>
              <Button type="submit">
                <Save className="h-4 w-4 mr-2" />
                保存
              </Button>
            </form>
            <p class="text-sm text-muted-foreground">超过 {retentionDays} 天的邮件将被自动清理</p>
          </div>

          <div class="pt-4 border-t">
            <form method="POST">
              <input type="hidden" name="action" value="cleanup" />
              <Button type="submit" variant="destructive" className="w-full" onclick="return confirm('确定清理过期邮件？')">
                <AlertTriangle className="h-4 w-4 mr-2" />
                立即清理过期邮件
              </Button>
            </form>
          </div>
        </CardContent>
      </Card>

      <!-- 配置说明 -->
      <Card className="md:col-span-2">
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <AlertTriangle className="h-5 w-5 text-yellow-500" />
            配置说明
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div class="text-sm text-muted-foreground space-y-4">
            <p>每个域名都需要在 Cloudflare 配置邮件路由，否则无法接收邮件：</p>
            <ol class="list-decimal list-inside space-y-2 ml-2">
              <li>进入 Cloudflare Dashboard → 对应域名 → Email → Email Routing</li>
              <li>启用 Email Routing (如果尚未启用)</li>
              <li>
                添加 Catch-all 规则:
                <ul class="list-disc list-inside ml-6 mt-1 text-foreground">
                  <li>Action: <span class="font-medium">Send to Worker</span></li>
                  <li>Destination: <code class="bg-muted px-1 py-0.5 rounded text-xs">xmail-email-worker</code></li>
                </ul>
              </li>
            </ol>
          </div>
        </CardContent>
      </Card>
    </div>
  </div>
</AdminLayout>
