---
import Layout from "../../layouts/Layout.astro"
import { createDB, verifyAdmin, createAdmin, getAdminById } from "database"
import { generateAdminToken, verifyToken } from "../../lib/auth"
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "../../components/ui/card"
import { Button } from "../../components/ui/button"
import { Input } from "../../components/ui/input"
import { Lock } from "lucide-react"

const db = createDB(Astro.locals.runtime.env.DB)
const jwtSecret = Astro.locals.runtime.env.JWT_SECRET
const adminPassword = Astro.locals.runtime.env.ADMIN_PASSWORD

let error = ""
let success = false

// 检查是否已登录
const token = Astro.cookies.get("admin_token")?.value
if (token) {
  const payload = await verifyToken(token, jwtSecret)
  if (payload?.type === "admin") {
    return Astro.redirect("/admin")
  }
}

// 处理登录表单
if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData()
  const username = formData.get("username")?.toString() || ""
  const password = formData.get("password")?.toString() || ""

  if (username && password) {
    // 尝试验证现有管理员
    let admin = await verifyAdmin(db, username, password)

    // 如果没有管理员且使用默认密码，创建第一个管理员
    if (!admin && password === adminPassword) {
      try {
        admin = await createAdmin(db, username, password)
      } catch (e) {
        // 可能用户名已存在
        error = "用户名已存在或密码错误"
      }
    }

    if (admin) {
      const newToken = await generateAdminToken(admin.id, jwtSecret)
      Astro.cookies.set("admin_token", newToken, {
        httpOnly: true,
        secure: import.meta.env.PROD,
        sameSite: "lax",
        path: "/",
        maxAge: 60 * 60 * 24, // 24小时
      })
      return Astro.redirect("/admin")
    } else {
      error = "用户名或密码错误"
    }
  } else {
    error = "请输入用户名和密码"
  }
}
---

<Layout title="管理员登录">
  <div class="min-h-screen flex items-center justify-center bg-muted/50 p-4">
    <Card class="w-full max-w-md">
      <CardHeader className="space-y-1 text-center">
        <div class="flex justify-center mb-4">
          <div class="w-12 h-12 bg-primary rounded-xl flex items-center justify-center text-primary-foreground">
            <Lock className="w-6 h-6" />
          </div>
        </div>
        <CardTitle className="text-2xl">XMail 管理后台</CardTitle>
        <CardDescription>请输入管理员账号密码登录</CardDescription>
      </CardHeader>
      <CardContent>
        {error && (
          <div class="bg-destructive/15 text-destructive text-sm p-3 rounded-md mb-4">
            {error}
          </div>
        )}

        <form method="POST" class="space-y-4">
          <div class="space-y-2">
            <label class="text-sm font-medium leading-none" for="username">
              用户名
            </label>
            <Input
              type="text"
              id="username"
              name="username"
              required
              placeholder="admin"
            />
          </div>

          <div class="space-y-2">
            <label class="text-sm font-medium leading-none" for="password">
              密码
            </label>
            <Input
              type="password"
              id="password"
              name="password"
              required
              placeholder="••••••••"
            />
          </div>

          <Button type="submit" className="w-full">
            登录
          </Button>
        </form>

        <p class="mt-4 text-xs text-muted-foreground text-center">
          首次登录请使用环境变量中设置的 ADMIN_PASSWORD
        </p>
      </CardContent>
    </Card>
  </div>
</Layout>
